name: Deploy to Firebase

on:
  push:
    branches:
      - alquilame

env:
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed for creating tags/releases

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for semantic versioning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create .env.prod from secrets
        run: |
          echo "NUXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NUXT_PUBLIC_FIREBASE_API_KEY }}" >> .env.prod
          echo "NUXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NUXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" >> .env.prod
          echo "NUXT_PUBLIC_FIREBASE_PROJECT_ID=rentacar-403321" >> .env.prod
          echo "NUXT_PUBLIC_RENTACAR_API_RESERVAS_DATA_ENDPOINT=${{ secrets.NUXT_PUBLIC_RENTACAR_API_RESERVAS_DATA_ENDPOINT }}" >> .env.prod
          echo "NUXT_PUBLIC_RENTACAR_API_RESERVAS_FORM_RECORD_ENDPOINT=${{ secrets.NUXT_PUBLIC_RENTACAR_API_RESERVAS_FORM_RECORD_ENDPOINT }}" >> .env.prod
          echo "NUXT_PUBLIC_RENTACAR_API_RESERVAS_CATEGORIES_AVAILABILITY_ENDPOINT=${{ secrets.NUXT_PUBLIC_RENTACAR_API_RESERVAS_CATEGORIES_AVAILABILITY_ENDPOINT }}" >> .env.prod

      - name: Build
        run: pnpm run build

      - name: Fix Firebase Functions dependencies
        working-directory: .output/server
        run: |
          rm -rf node_modules
          npm install --omit=dev

      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: rentacar-403321

      - name: Setup Firebase credentials
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > $HOME/gcloud-service-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcloud-service-key.json" >> $GITHUB_ENV

      - name: Deploy Functions
        run: |
          npm install -g firebase-tools
          # Retry logic for transient network errors (ECONNRESET)
          max_attempts=3
          attempt=1
          until firebase deploy --only functions:rentacar_main_alquilame; do
            if [ $attempt -ge $max_attempts ]; then
              echo "Failed after $max_attempts attempts"
              exit 1
            fi
            echo "Attempt $attempt failed, retrying in 30s..."
            sleep 30
            attempt=$((attempt + 1))
          done

      - name: Determine version bump
        id: version
        run: |
          TAG_PREFIX="alquilame-v"

          # Get latest tag matching our prefix
          LATEST_TAG=$(git tag -l "${TAG_PREFIX}*" --sort=-v:refname | head -1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="${TAG_PREFIX}0.0.0"
          fi
          echo "Latest tag: $LATEST_TAG"

          # Extract version numbers (remove prefix first)
          VERSION=${LATEST_TAG#$TAG_PREFIX}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Analyze commits since last tag
          COMMITS=$(git log ${LATEST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

          # Determine bump type based on conventional commits
          if echo "$COMMITS" | grep -qE "^BREAKING CHANGE:|^[a-z]+!:"; then
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            BUMP="major"
          elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
            MINOR=$((MINOR + 1))
            PATCH=0
            BUMP="minor"
          else
            PATCH=$((PATCH + 1))
            BUMP="patch"
          fi

          NEW_VERSION="${TAG_PREFIX}${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION ($BUMP)"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
